<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sound Test</title>
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #playerWrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      margin: auto;
      max-width: 300px;
    }

    #metronomeControls {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      line-height: normal;
    }

    #metronomeControls {
      font-size: 2.5rem;
    }

    #toggleButton {
      width: 1.5em;
      height: 1.5em;
      cursor: pointer;
      border: none;
      background: none;
      outline: none;
    }

    .icon {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <header>
    Sound Test
  </header>
  <div id="playerWrapper">
    <audio id="woodblock" src="freesound.org-692819-woodblock.mp3"
      preload="auto"></audio>

    <div id="metronomeControls">
      <button id="toggleButton" aria-label="Play">Play</button>
      <div id="timer">00:00</div>
    </div>
  </div>

  <script>
    const audioElement = document.getElementById('woodblock');
    const toggleButton = document.getElementById('toggleButton');
    const timerDisplay = document.getElementById('timer');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioBuffer = null;
    let isPlaying = false;
    let intervalId = null;
    let elapsedSeconds = 0;

    async function loadAudioFromElement(elem) {
      const response = await fetch(elem.src);
      const arrayBuffer = await response.arrayBuffer();
      audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    }

    function playSound() {
      if (!audioBuffer) return;
      const source = audioCtx.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(audioCtx.destination);
      source.start(0);
    }

    function togglePlayback() {
      if (!isPlaying) {
        // Start playing every second
        isPlaying = true;
        toggleButton.textContent = 'Pause';
        intervalId = setInterval(() => {
          playSound();
          elapsedSeconds++;
          timerDisplay.textContent = new Date(elapsedSeconds * 1000)
            .toISOString().substr(14, 5); // mm:ss
        }, 1000);
      } else {
        // Stop
        isPlaying = false;
        toggleButton.textContent = 'Play';
        clearInterval(intervalId);
        intervalId = null;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadAudioFromElement(audioElement);
      toggleButton.addEventListener('click', togglePlayback);
    });
  </script>
</body>

</html>
